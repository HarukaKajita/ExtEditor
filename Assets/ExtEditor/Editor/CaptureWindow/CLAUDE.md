# CaptureWindow Tool

このファイルは、CaptureWindowツールでの作業時にClaude Codeへのガイダンスを提供します。

## ツール概要

CaptureWindowツールは、Unity内の様々なビューからスクリーンショットを撮影し、PNGファイルとして保存するエディター拡張です。Game View、Scene View、カスタムRenderTextureに対応しています。

## 主要機能

### 基本機能
- **マルチソース撮影**: Game View、Scene View、カスタムRenderTextureから撮影
- **カメラ選択**: シーンカメラから選択またはカスタムカメラを指定
- **アルファチャンネルサポート**: PNG出力時にアルファチャンネルを含める
- **透明背景**: 透明背景での撮影オプション
- **高度なファイル名システム**: パターンベースのファイル名生成
- **テイク番号管理**: 自動インクリメントと桁数固定
- **パス指定方式**: 相対パスと絶対パスの切り替え
- **最近のキャプチャ履歴**: 直近5件のキャプチャを表示
- **キーボードショートカット**: F9 + Cmd/Ctrl + Shift でクイック撮影

### パターンシステム
利用可能なパターン:
- `<Date>`: 日付（yyyyMMdd形式）
- `<Time>`: 時刻（HHmmss形式）
- `<DateTime>`: 日時（yyyyMMdd_HHmmss形式）
- `<Take>`: テイク番号（自動インクリメント対応）
- `<Camera>`: カメラ名
- `<Scene>`: シーン名
- `<Project>`: プロジェクト名
- `<Source>`: キャプチャソース名

### 使用方法
1. **ツール → CaptureWindow**メニューからアクセス
2. 撮影ソースを選択（Game View/Scene View/RenderTexture）
3. ドロップダウンまたはObjectFieldからターゲットカメラを選択
4. パス指定方式を選択（相対/絶対）
5. 出力ディレクトリを設定（パターン使用可）
6. ファイル名テンプレートを設定
7. アルファチャンネルと背景オプションを設定
8. "Capture and Save PNG"をクリックまたはショートカットを使用
9. "Open Output Folder"で保存画像を確認

## 実装詳細

### ファイル構造（リファクタリング後）
- **CaptureWindow.cs**: メインのEditorWindowクラス（UIコントローラー）
- **CaptureWindowState.cs**: 状態管理クラス
- **CaptureCore.cs**: キャプチャ処理のコアロジック
- **CaptureWindowUI.cs**: UI描画ロジック
- **PatternResolver.cs**: パターン置換システム
- **CaptureValidator.cs**: 入力検証
- **CaptureLocalization.cs**: 多言語対応
- **CaptureSettings.cs**: 設定保存用ScriptableObject

### アーキテクチャ
- **MVVM風設計**: 状態(Model)、ロジック(Core)、UI(View)の分離
- **依存性注入**: UIクラスは状態とコールバックを受け取る
- **単一責任原則**: 各クラスが明確な役割を持つ

### 撮影メカニズム
- **RenderTexture**: すべての撮影操作にRenderTextureを使用
- **カメラ状態管理**: 撮影後に適切にカメラ状態を復元
- **エラーハンドリング**: try-finallyブロックでリソースを確実に解放
- **複数撮影モード**: ウィンドウ撮影とショートカット撮影に対応

### 技術的特徴
- **パス変換**: 相対パス⇔絶対パスの自動変換
- **パターン置換**: 柔軟なファイル名・パス生成
- **バリデーション**: リアルタイムの入力検証
- **状態管理**: 設定の永続化と復元
- **UI更新**: 状態変更時の自動UI更新

## 設定詳細

### キーボードショートカット
- **ショートカット**: `F9 + Cmd/Ctrl + Shift`
- **機能**: 現在の設定でクイック撮影を実行

### 出力設定
- **デフォルト出力先**: `/Captures`（相対パス）
- **ファイル形式**: PNG（アルファチャンネル対応）
- **命名規則**: `Capture_<Date>_<Time>.png`（カスタマイズ可能）

### 撮影オプション
- **アルファチャンネル**: 透明度情報を含める
- **背景透明化**: 背景を透明にして撮影
- **テイク番号桁数固定**: 001, 0001などの形式
- **自動アセット更新**: 撮影後にAssetDatabase.Refresh()を実行

## 開発ノート

### エラーハンドリング
- 出力ディレクトリ作成失敗時の処理
- カメラが見つからない場合の警告
- RenderTexture作成失敗時の処理
- パス変換エラー時のフォールバック

### パフォーマンス考慮
- RenderTextureの適切な解放
- 撮影時のカメラ状態の最小限の変更
- メモリ効率的な画像処理
- UI更新の最適化

### 拡張可能性
- 新しいパターンの追加は`PatternResolver`クラスで実装
- 新しい撮影ソースの追加は`CaptureSource`enumと対応するメソッドで実装
- 出力形式の拡張は`CaptureCore`クラスの保存メソッドを拡張
- 新しいバリデーションルールは`CaptureValidator`クラスに追加

### API設計
- 外部からの操作用にpublicメソッドを提供
- 状態の取得・設定メソッド
- プログラムからの撮影実行

### 今後の改善案
- 設定のプリセット機能
- 複数ファイル形式への対応（JPG、TGA等）
- バッチ撮影機能
- 撮影後の自動処理（リサイズ、圧縮等）
- クラウド保存対応

## 最新のリファクタリング内容

### 2025年1月の改善
- **コード分離**: 巨大な単一ファイルを責任ごとに分離
  - CaptureWindow.cs: UIコントローラー
  - CaptureWindowState.cs: 状態管理
  - CaptureCore.cs: キャプチャロジック
  - CaptureWindowUI.cs: UI描画
  
- **パス指定方式の改善**: 
  - 相対/絶対パス切り替え時の自動変換
  - パターンを含むパスの適切な処理
  
- **設計パターンの適用**:
  - MVVM風アーキテクチャ
  - 依存性注入
  - 単一責任原則

### 以前の課題の解決状況

**解決済み**:
- ✅ メモリリーク: CaptureCore.csでtry-finallyブロックを使用
- ✅ カメラ状態復元: finallyブロックで確実に復元
- ✅ コードの可読性: 適切なクラス分離により改善

**部分的に解決**:
- ⚠️ 多言語対応: CaptureLocalization.csで管理されているが、まだ改善の余地あり
- ⚠️ パス検証: CaptureValidator.csで実装されているが、セキュリティ面で追加検証が必要

**未解決**:
- ❌ スレッドセーフティ: 静的変数lastInstanceの同期処理未実装
- ❌ プリセット機能: 未実装
- ❌ バッチ撮影機能: 未実装